name: Build worker/job (changed paths)

on:
  push:
    branches: [ "main" ]
    paths:
      - "worker/**"
      - "job/**"
      - ".github/workflows/build.yml"
  pull_request:
    branches: [ "main" ]
    paths:
      - "worker/**"
      - "job/**"
      - ".github/workflows/build.yml"
  workflow_dispatch: {}

permissions:
  contents: read
  id-token: write  # WIF

env:
  AR_LOC: ${{ vars.AR_LOC }}
  PROJECT_ID: ${{ vars.PROJECT_ID }}
  WORKER_REPO: ${{ vars.WORKER_REPO }}
  JOB_REPO: ${{ vars.JOB_REPO }}
  WORKER_TORCH_DEVICE: ${{ vars.WORKER_TORCH_DEVICE }}   # cpu | cu121 | cu122...
  JOB_TORCH_DEVICE: ${{ vars.JOB_TORCH_DEVICE }}         # cpu | cu121 | cu122...

concurrency:
  group: build-${{ github.ref }}-${{ github.workflow }}
  cancel-in-progress: false

jobs:
  plan-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      - id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            worker:
              - 'worker/**'
            job:
              - 'job/**'

      - id: set
        shell: bash
        run: |
          MATRIX='{"include":[]}'
          add_entry () {
            local name="$1" path="$2" repo="$3" torch="$4"
            MATRIX=$(jq -c --arg n "$name" --arg p "$path" --arg r "$repo" --arg t "$torch" \
              '.include += [{"name":$n,"path":$p,"repo":$r,"torch":$t}]' <<<"$MATRIX")
          }

          # Añade targets cambiados
          if [[ "${{ steps.changes.outputs.worker }}" == 'true' ]]; then
            add_entry "worker" "worker" "${{ env.WORKER_REPO }}" "${{ env.WORKER_TORCH_DEVICE }}"
          fi
          if [[ "${{ steps.changes.outputs.job }}" == 'true' ]]; then
            add_entry "job" "job" "${{ env.JOB_REPO }}" "${{ env.JOB_TORCH_DEVICE }}"
          fi

          # Fallback: si no detectó cambios, construye ambos
          if [[ "$MATRIX" == '{"include":[]}' ]]; then
            add_entry "worker" "worker" "${{ env.WORKER_REPO }}" "${{ env.WORKER_TORCH_DEVICE }}"
            add_entry "job"    "job"    "${{ env.JOB_REPO }}"    "${{ env.JOB_TORCH_DEVICE }}"
          fi

          echo "matrix=$MATRIX" >> "$GITHUB_OUTPUT"

  build-and-push:
    needs: plan-matrix
    if: ${{ needs.plan-matrix.outputs.matrix != '{"include":[]}' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.plan-matrix.outputs.matrix) }}

    steps:
      - uses: actions/checkout@v4

      # Auth GCP vía WIF (sin JSON)
      - name: Auth to Google Cloud (WIF)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Docker login to Artifact Registry
        run: gcloud auth configure-docker "${{ env.AR_LOC }}-docker.pkg.dev" --quiet

      #  Buildx + caché
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Compute image meta
        id: meta
        shell: bash
        run: |
          REG_HOST="${{ env.AR_LOC }}-docker.pkg.dev"
          IMAGE_BASE="${REG_HOST}/${{ env.PROJECT_ID }}/${{ matrix.repo }}/${{ matrix.name }}"
          SHORT_SHA="${GITHUB_SHA::7}"
          BRANCH="${GITHUB_REF_NAME//\//-}"
          DATE_TAG="$(date -u +%Y%m%d)"
          TORCH="${{ matrix.torch }}"

          echo "IMAGE_BASE=$IMAGE_BASE"       >> $GITHUB_OUTPUT
          echo "TAG_SHA=${TORCH}-${GITHUB_SHA}" >> $GITHUB_OUTPUT
          echo "TAG_LATEST=${TORCH}-latest"     >> $GITHUB_OUTPUT
          echo "TAG_SHORT=${TORCH}-${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "TAG_BRANCH=${TORCH}-${BRANCH}"   >> $GITHUB_OUTPUT
          echo "TAG_DATE=${TORCH}-${DATE_TAG}"   >> $GITHUB_OUTPUT

      # Labels OCI útiles
      - name: Labels
        id: labels
        run: |
          echo "labels=org.opencontainers.image.source=${{ github.repository }},org.opencontainers.image.revision=${{ github.sha }},org.opencontainers.image.created=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT

      - name: Build & Push (cache)
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.path }}
          file: ${{ matrix.path }}/Dockerfile
          push: true
          build-args: |
            TORCH_DEVICE=${{ matrix.torch }}
          labels: ${{ steps.labels.outputs.labels }}
          tags: |
            ${{ steps.meta.outputs.IMAGE_BASE }}:${{ steps.meta.outputs.TAG_SHA }}
            ${{ steps.meta.outputs.IMAGE_BASE }}:${{ steps.meta.outputs.TAG_LATEST }}
            ${{ steps.meta.outputs.IMAGE_BASE }}:${{ steps.meta.outputs.TAG_SHORT }}
            ${{ steps.meta.outputs.IMAGE_BASE }}:${{ steps.meta.outputs.TAG_BRANCH }}
            ${{ steps.meta.outputs.IMAGE_BASE }}:${{ steps.meta.outputs.TAG_DATE }}
          cache-from: |
            type=gha,scope=${{ matrix.name }}-${{ matrix.torch }}
          cache-to: |
            type=gha,mode=max,scope=${{ matrix.name }}-${{ matrix.torch }}
