name: Build worker/job (changed paths)

on:
  push:
    branches: [ "main" ]
    paths:
      - "worker/**"
      - "job/**"
      - ".github/workflows/build.yml"
  pull_request:
    branches: [ "main" ]
    paths:
      - "worker/**"
      - "job/**"
      - ".github/workflows/build.yml"
  workflow_dispatch: {}

permissions:
  contents: read
  id-token: write   # necesario para WIF

env:
  AR_LOC: ${{ vars.AR_LOC }}
  PROJECT_ID: ${{ vars.PROJECT_ID }}
  WORKER_REPO: ${{ vars.WORKER_REPO }}
  JOB_REPO: ${{ vars.JOB_REPO }}
  WORKER_TORCH_DEVICE: ${{ vars.WORKER_TORCH_DEVICE }}   # cpu | cu121 | cu122...
  JOB_TORCH_DEVICE: ${{ vars.JOB_TORCH_DEVICE }}         # cpu | cu121 | cu122...

jobs:
  plan-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      - id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            worker:
              - 'worker/**'
            job:
              - 'job/**'

      - id: set
        shell: bash
        run: |
          sudo apt-get update -y >/dev/null
          sudo apt-get install -y jq >/dev/null
          MATRIX=$(jq -cn '{include: []}')
          if [[ "${{ steps.changes.outputs.worker }}" == 'true' ]]; then
            MATRIX=$(jq -c --arg repo "${{ env.WORKER_REPO }}" --arg torch "${{ env.WORKER_TORCH_DEVICE }}" \
              '.include += [{name:"worker",path:"worker",repo:$repo,torch:$torch}]' <<<"$MATRIX")
          fi
          if [[ "${{ steps.changes.outputs.job }}" == 'true' ]]; then
            MATRIX=$(jq -c --arg repo "${{ env.JOB_REPO }}" --arg torch "${{ env.JOB_TORCH_DEVICE }}" \
              '.include += [{name:"job",path:"job",repo:$repo,torch:$torch}]' <<<"$MATRIX")
          fi
          # fallback: si no detecta cambios, construye ambos
          if [[ "$MATRIX" == '{"include":[]}' ]]; then
            MATRIX=$(jq -cn \
              --arg wrepo "${{ env.WORKER_REPO }}" --arg wtorch "${{ env.WORKER_TORCH_DEVICE }}" \
              --arg jrepo "${{ env.JOB_REPO }}"   --arg jtorch "${{ env.JOB_TORCH_DEVICE }}" \
              '{include: [
                {name:"worker",path:"worker",repo:$wrepo,torch:$wtorch},
                {name:"job",   path:"job",   repo:$jrepo,torch:$jtorch}
              ]}')
          fi
          echo "matrix=$MATRIX" >> "$GITHUB_OUTPUT"

  build-and-push:
    needs: plan-matrix
    if: ${{ needs.plan-matrix.outputs.matrix != '{"include":[]}' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.plan-matrix.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4

      - name: Check WIF secrets present
        run: |
          if [ -z "${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}" ]; then
            echo " Falta secret GCP_WORKLOAD_IDENTITY_PROVIDER"; exit 1; fi
          if [ -z "${{ secrets.GCP_SERVICE_ACCOUNT }}" ]; then
            echo " Falta secret GCP_SERVICE_ACCOUNT"; exit 1; fi
          echo " Secrets OK"

      #  AutenticaciÃ³n GCP por WIF (sin JSON)
      - name: Auth to Google Cloud (WIF)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Docker login to Artifact Registry
        run: gcloud auth configure-docker "${{ env.AR_LOC }}-docker.pkg.dev" --quiet

      - name: Build image
        env:
          REG_HOST: ${{ env.AR_LOC }}-docker.pkg.dev
          PROJECT_ID: ${{ env.PROJECT_ID }}
          REPO: ${{ matrix.repo }}
          IMAGE: ${{ matrix.name }}
          TORCH: ${{ matrix.torch }}
          PATH_DIR: ${{ matrix.path }}
          BRANCH: ${{ github.ref_name }}
        run: |
          IMAGE_BASE="${REG_HOST}/${PROJECT_ID}/${REPO}/${IMAGE}"
          IMAGE_TAG_SHA="${IMAGE_BASE}:${TORCH}-${GITHUB_SHA}"
          IMAGE_TAG_LATEST="${IMAGE_BASE}:${TORCH}-latest"
          IMAGE_TAG_BRANCH="${IMAGE_BASE}:${TORCH}-${BRANCH//\//-}"

          echo "IMAGE_TAG_SHA=$IMAGE_TAG_SHA" >> $GITHUB_ENV
          echo "IMAGE_TAG_LATEST=$IMAGE_TAG_LATEST" >> $GITHUB_ENV
          echo "IMAGE_TAG_BRANCH=$IMAGE_TAG_BRANCH" >> $GITHUB_ENV

          docker build \
            --build-arg TORCH_DEVICE="$TORCH" \
            -t "$IMAGE_TAG_SHA" \
            -t "$IMAGE_TAG_BRANCH" \
            -f "${PATH_DIR}/Dockerfile" "${PATH_DIR}"

      - name: Tag & Push image
        run: |
          docker tag "$IMAGE_TAG_SHA" "$IMAGE_TAG_LATEST"
          docker push "$IMAGE_TAG_SHA"
          docker push "$IMAGE_TAG_LATEST"
          docker push "$IMAGE_TAG_BRANCH"
