name: Build worker/job (changed paths)

on:
  push:
    branches: [ "main" ]
    paths:
      - "worker/**"
      - "job/**"
      - ".github/workflows/build.yml"
  pull_request:
    branches: [ "main" ]
    paths:
      - "worker/**"
      - "job/**"
      - ".github/workflows/build.yml"

permissions:
  contents: read
  id-token: write

env:
  AR_LOC: ${{ vars.AR_LOC }}
  PROJECT_ID: ${{ vars.PROJECT_ID }}
  WORKER_REPO: ${{ vars.WORKER_REPO }}
  JOB_REPO: ${{ vars.JOB_REPO }}
  WORKER_TORCH_DEVICE: ${{ vars.WORKER_TORCH_DEVICE }}   # cpu | cu121 | cu122, etc.
  JOB_TORCH_DEVICE: ${{ vars.JOB_TORCH_DEVICE }}         # cpu | cu121 | cu122, etc.

jobs:
  plan-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      - id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            worker:
              - 'worker/**'
            job:
              - 'job/**'

      - id: set
        shell: bash
        run: |
          sudo apt-get update -y >/dev/null
          sudo apt-get install -y jq >/dev/null

          MATRIX=$(jq -cn '{include: []}')

          if [[ "${{ steps.changes.outputs.worker }}" == 'true' ]]; then
            MATRIX=$(jq -c \
              --arg repo "${{ env.WORKER_REPO }}" \
              --arg torch "${{ env.WORKER_TORCH_DEVICE }}" \
              '.include += [{name:"worker",path:"worker",repo:$repo,torch:$torch}]' \
              <<<"$MATRIX")
          fi

          if [[ "${{ steps.changes.outputs.job }}" == 'true' ]]; then
            MATRIX=$(jq -c \
              --arg repo "${{ env.JOB_REPO }}" \
              --arg torch "${{ env.JOB_TORCH_DEVICE }}" \
              '.include += [{name:"job",path:"job",repo:$repo,torch:$torch}]' \
              <<<"$MATRIX")
          fi

          echo "matrix=$MATRIX" >> "$GITHUB_OUTPUT"

  build-and-push:
    needs: plan-matrix
    if: ${{ needs.plan-matrix.outputs.matrix != '{"include":[]}' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.plan-matrix.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4

      - name: Check secret present
        env:
          GCP_CREDENTIALS: ${{ secrets.GCP_CREDENTIALS }}
        shell: bash
        run: |
          if [[ -z "$GCP_CREDENTIALS" ]]; then
            echo "Missing GCP_CREDENTIALS secret"
            exit 1
          fi
          echo "Secret is present"

      - name: Auth to Google Cloud (JSON)
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Docker login to Artifact Registry
        run: |
          gcloud auth configure-docker "${{ env.AR_LOC }}-docker.pkg.dev" --quiet

      - name: Build image
        env:
          REG_HOST: ${{ env.AR_LOC }}-docker.pkg.dev
          PROJECT_ID: ${{ env.PROJECT_ID }}
          REPO: ${{ matrix.repo }}      
          IMAGE: ${{ matrix.name }}     
          TORCH: ${{ matrix.torch }}
          PATH_DIR: ${{ matrix.path }}
        run: |
          IMAGE_BASE="${REG_HOST}/${PROJECT_ID}/${REPO}/${IMAGE}"
          IMAGE_TAG_SHA="${IMAGE_BASE}:${TORCH}-${GITHUB_SHA}"
          IMAGE_TAG_LATEST="${IMAGE_BASE}:${TORCH}-latest"

          echo "IMAGE_TAG_SHA=$IMAGE_TAG_SHA" >> $GITHUB_ENV
          echo "IMAGE_TAG_LATEST=$IMAGE_TAG_LATEST" >> $GITHUB_ENV

          docker build \
            --build-arg TORCH_DEVICE="$TORCH" \
            -t "$IMAGE_TAG_SHA" \
            -f "${PATH_DIR}/Dockerfile" "${PATH_DIR}"

      - name: Tag & Push image
        run: |
          docker tag "$IMAGE_TAG_SHA" "$IMAGE_TAG_LATEST"
          docker push "$IMAGE_TAG_SHA"
          docker push "$IMAGE_TAG_LATEST"
